title: Add an aggregation pipeline stage.
level: 4
ref: add-pipeline-stage
content: |

   In the aggregation pipeline pane in the bottom-left of the view,
   click the :guilabel:`Select...` dropdown and select the
   :manual:`aggregation pipeline stage
   </reference/operator/aggregation-pipeline/>` to use for the first
   stage of the pipeline:

   .. raw:: html

      <br>

   .. figure:: /images/compass/agg-builder-select-stage.png
      :alt: Aggregation Builder select stage

   .. note::

      If :guilabel:`Comment Mode` is enabled, the pre-filled content
      of the pipeline stage changes based on the selected stage to
      provide syntactic guidelines.
---
title: Fill in the pipeline stage.
level: 4
ref: fill-in-stage
content: |
   Fill in your selected stage. As you modify the pipeline stage, the
   preview documents shown in the pane to the right of the stage
   update automatically to reflect the results of your pipeline as it
   progresses, provided :guilabel:`Auto Preview` is enabed:

   .. raw:: html

      <br>

   .. figure:: /images/compass/agg-builder-match-stage.png
      :alt: Aggregation Builder match stage example

---
title: Add additional pipeline stages.
level: 4
ref: add-additional-stages
content: |
   Add additional aggregation stages as desired by clicking the
   :guilabel:`Add Stage` button below your last aggregation stage.
   Repeat steps 1 and 2 for each additional stage.

   .. note::

      The toggle to the right of the name of each pipeline stage
      dictates whether that stage is included in the pipeline. Toggling
      a pipeline stage also updates the pipeline preview, which reflects
      whether or not that stage is included.

      .. example::

         The following pipeline excludes the first
         :manual:`$match </reference/operator/aggregation/match/>` stage
         and only includes the
         :manual:`$project </reference/operator/aggregation/project/>`
         stage:

         .. figure:: /images/compass/agg-builder-exclude-stage-example.png
            :alt: Aggregation Builder exclude stage example
---
title: Optional. Use custom collation.
level: 4
ref: use-custom-collation
content: |
   a. Click the :guilabel:`Expand` icon to the left of the
      :guilabel:`Folder` icon.

   b. Enter the desired :manual:`collation document </reference/collation/>`.

      Collation allows users to specify language-specific rules for
      string comparison, such as rules for lettercase and accent marks.

   .. figure:: /images/compass/agg-builder-collation-stage-example.png
            :alt: Aggregation Builder collation stage example
...

